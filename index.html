<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = deg2rad(lat2 - lat1);
        const dLng = deg2rad(lng2 - lng1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c * 1000;
      }

      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }

      function getImageBasedOnLocation(latitude, longitude) {
        const locationA = { lat: 24.34031322856674, lng: 124.15835542423535 };
        const locationB = { lat: 24.337916686319687, lng: 124.16563584582616 };
        const distanceA = getDistance(latitude, longitude, locationA.lat, locationA.lng);
        const distanceB = getDistance(latitude, longitude, locationB.lat, locationB.lng);

        if (distanceA <= 10) {
          return { image: 'imagea.png', type: 'inside' };
        } else if (distanceB <= 10) {
          return { image: 'imageb.png', type: 'inside' };
        } else {
          return { image: null, type: 'outside' };
        }
      }

      function updateMessage(message) {
        document.getElementById('message').innerText = message;
      }

      function updateDirectionArrow(locationType) {
        const arrow = document.querySelector('#direction-arrow');
        const circle = document.querySelector('#inside-circle');

        if (locationType === 'inside') {
          arrow.setAttribute('visible', false);
          circle.setAttribute('visible', true);
        } else {
          arrow.setAttribute('visible', true);
          circle.setAttribute('visible', false);
        }
      }

      async function initAR() {
        try {
          await navigator.permissions.query({ name: 'geolocation' });
          navigator.geolocation.watchPosition((position) => {
            const { latitude, longitude } = position.coords;
            const { image, type } = getImageBasedOnLocation(latitude, longitude);

            if (image) {
              document.querySelector('#ar-image').setAttribute('src', image);
              updateMessage('指定された座標の範囲内です');
            } else {
              updateMessage('ARマーカーが認識範囲外です。指定された座標の近くに移動してください。');
            }
            updateDirectionArrow(type);
          });
        } catch (error) {
         
          alert('位置情報のアクセスが許可されていません。設定を確認してください。');
        }
      }
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;" onload="initAR()">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-marker type="pattern" url="pattern-shiroharaAR.patt">
        <a-image id="ar-image" position="0 0 0" scale="1 1 1"></a-image>
        <a-entity id="direction-arrow" position="0 -1 0" scale="0.5 0.5 0.5" geometry="primitive: cone; radiusBottom: 0.1; radiusTop: 0; height: 0.5" material="color: blue" visible="false"></a-entity>
        <a-entity id="inside-circle" position="0 -1 0" scale="0.5 0.5 0.5" geometry="primitive: sphere; radius: 0.1" material="color: green" visible="false"></a-entity>
      </a-marker>
    </a-scene>
    <div id="message" style="position: fixed; top: 10px; left: 10px; z-index: 100; color: white; background-color: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px;"></div>
  </body>
</html>
