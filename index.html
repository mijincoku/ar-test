<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
      function getDistance(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = deg2rad(lat2 - lat1);
        const dLng = deg2rad(lng2 - lng1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c * 1000;
      }

      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }

      function getLocationInfo(latitude, longitude) {
        const locationA = { lat: 24.34031322856674, lng: 124.15835542423535, id: 'A' };
        const locationB = { lat: 24.337916686319687, lng: 124.16563584582616, id: 'B' };
        const distanceA = getDistance(latitude, longitude, locationA.lat, locationA.lng);
        const distanceB = getDistance(latitude, longitude, locationB.lat, locationB.lng);

        if (distanceA <= 10) {
          return { image: 'imagea.png', type: 'inside', location: locationA };
        } else if (distanceB <= 10) {
          return { image: 'imageb.png', type: 'inside', location: locationB };
        } else {
          const nearestLocation = distanceA < distanceB ? locationA : locationB;
          const nearestDistance = distanceA < distanceB ? distanceA : distanceB;
          return { image: null, type: 'outside', location: nearestLocation, distance: nearestDistance };
        }
      }

      function updateMessage(type, distance) {
        const messageElement = document.getElementById('message');
        if (type === 'inside') {
          messageElement.innerHTML = '<span style="color:green;">●</span>';
        } else {
          messageElement.innerHTML = `<span style="color:blue;">➡️</span> ${distance.toFixed(2)}m`;
        }
      }

      async function updateLocation() {
        try {
          const position = await new Promise((resolve, reject) =>
            navigator.geolocation.getCurrentPosition(resolve, reject)
          );
          const { latitude, longitude } = position.coords;
          const { image, type, location, distance } = getLocationInfo(latitude, longitude);

          if (image) {
            document.querySelector('#ar-image').setAttribute('src', image);
          }
          updateMessage(type, distance);
        } catch (error) {
          alert('位置情報のアクセスが許可されていません。設定を確認してください。');
        }
      }

      function initAR() {
        setInterval(updateLocation, 5000);
      }
    </script>
  </head>
  <body style="margin: 0; overflow: hidden;" onload="initAR()">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-marker type="pattern" url="pattern-shiroharaAR.patt">
        <a-image id="ar-image" position="0 0 0" scale="1 1 1"></a-image>
      </a-marker>
    </a-scene>
    <div id="message" style="position: fixed; top: 10px; right: 10px; z-index: 100; color: white; background-color: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 5px;"></div>
  </body>
</html>
