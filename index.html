<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-assets>
            <a-asset-item id="arrow-obj" src="daiya.obj"></a-asset-item>
            <a-asset-item id="arrow-mtl" src="daiya.mtl"></a-asset-item>
        </a-assets>
        <a-marker-camera preset="custom" type="pattern" url="pattern-shiroharaAR.patt"></a-marker-camera>
        <a-entity id="arrow" obj-model="obj: #arrow-obj; mtl: #arrow-mtl" position="0 0.5 0" scale="0.1 0.1 0.1"></a-entity>
    </a-scene>
    
    <script>
        const arrow = document.querySelector('#arrow');
        const destination = { lat: 24.341380974874625, lon: 124.15850303220783 };
        
        function getCompassHeading(alpha, beta, gamma) {
            const degtorad = Math.PI / 180;
            const _x = beta ? beta * degtorad : 0;
            const _y = gamma ? gamma * degtorad : 0;
            const _z = alpha ? alpha * degtorad : 0;
            
            const cX = Math.cos(_x);
            const cY = Math.cos(_y);
            const cZ = Math.cos(_z);
            const sX = Math.sin(_x);
            const sY = Math.sin(_y);
            const sZ = Math.sin(_z);

            const Vx = -cZ * sY - sZ * sX * cY;
            const Vy = -sZ * sY + cZ * sX * cY;
            
            const compassHeading = Math.atan(Vx / Vy);

            if (Vy < 0) {
                return compassHeading + Math.PI;
            } else if (Vy > 0 && Vx < 0) {
                return compassHeading + Math.PI * 2;
            } else {
                return compassHeading;
            }
        }

        function updateArrowDirection() {
            navigator.geolocation.getCurrentPosition((position) => {
                const currentLatitude = position.coords.latitude;
                const currentLongitude = position.coords.longitude;
                const dLon = destination.lon - currentLongitude;

                const y = Math.sin(dLon) * Math.cos(destination.lat);
                const x = Math.cos(currentLatitude) * Math.sin(destination.lat) - Math.sin(currentLatitude) * Math.cos(destination.lat) * Math.cos(dLon);

                const bearing = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
                arrow.setAttribute('rotation', { x: 0, y: -bearing, z: 0 });
            });
        }
        window.addEventListener('deviceorientationabsolute', (event) => {
            const compassHeading = getCompassHeading(event.alpha, event.beta, event.gamma);
            arrow.setAttribute('rotation', { x: 0, y: -(compassHeading), z: 0 });
        });

        setInterval(updateArrowDirection, 1000);
    </script>
</body>
</html>
